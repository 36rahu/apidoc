{%- import "helper/code.html" as code %}

{%- macro diff_display_version(reference, method_versioned, attribute) -%}
    {%- for (method_version_name, method_version) in method_versioned.versions.items() -%}
        {%- if method_version[attribute] == reference %}{{ method_version_name }} {% endif -%}
    {%- endfor -%}
{%- endmacro -%}

{%- macro diff_display_version_objects(object) -%}
    {%- for version in object.versions -%}{{ version }} {% endfor -%}
{%- endmacro -%}

{%- macro diff_display_version_signature(signature, method_versioned, attribute) -%}
    {%- for (method_version_name, method_version) in method_versioned.versions.items() %}
        {%- for element in method_version[attribute].values() %}
            {%- if element.signature == signature %}{{ method_version_name }} {% endif %}
        {%- endfor -%}
    {%- endfor -%}
{%- endmacro -%}

{%- macro diff_display_version_signature_list(signature, method_versioned, attribute) -%}
    {%- for (method_version_name, method_version) in method_versioned.versions.items() %}
        {%- for element in method_version[attribute] %}
            {%- if element.signature == signature %}{{ method_version_name }} {% endif %}
        {%- endfor -%}
    {%- endfor -%}
{%- endmacro -%}

{%- macro diff_code_commented(method_versioned, objects, prefix="", suffix="", pad_length=0) -%}
    {%- set object_signed = method_versioned.objects_by_unit_signature(objects) %}
    {%- for object in object_signed %}
        {%- if object.type|lower == "object" %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="pun">{</span></td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
            {%- for property_name in method_versioned.objects_merge_properties(objects).keys()|sort %}
                {%- if loop.last %}
                    {{- diff_code_commented(method_versioned, method_versioned.objects_property_by_property_name(objects, property_name), code.property_name_decorator(property_name), "", pad_length + 1) }}
                {%- else %}
                    {{- diff_code_commented(method_versioned, method_versioned.objects_property_by_property_name(objects, property_name), code.property_name_decorator(property_name), "<span class=\"pun\">,</span>", pad_length + 1) }}
                {%- endif %}
            {%- endfor %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}<span class="pun">}</span>{{ suffix }}</td>
        <td></td>
    </tr>
        {%- elif object.type|lower == "array" %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="pun">[</span></td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
            {{- diff_code_commented(method_versioned, method_versioned.objects_items(objects), "", "", pad_length+1) }}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}<span class="pun">]</span>{{ suffix }}</td>
        <td></td>
    </tr>
        {%- elif object.type|lower in ("number", "string", "bool") %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="typ">{{ object.type|lower }}</span>{{ suffix }}</td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
        {%- elif object.type|lower == "none" %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="typ">null</span>{{ suffix }}</td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
        {%- elif object.type|lower == "dynamic" %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="pun">{</span></td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length + 1) }}<span class="typ">string</span><span class="pun">: </span><span class="typ">{{ object.item_type }}</span></td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}<span class="pun">}</span>{{ suffix }}</td>
        <td></td>
    </tr>
        {%- elif object.type|lower == "reference" %}
            {{- diff_code_commented(method_versioned, method_versioned.objects_reference(objects), prefix, suffix, pad_length) }}
        {%- else %}
    <tr class="diff_version" data-version="{{ diff_display_version_objects(object) }}">
        <td>{{ code.indent(pad_length) }}{{ prefix }}<span class="typ">{{ object.type_name }}</span>{{ suffix }}</td>
        <td class="com">{{ code.comment(object) }}</td>
    </tr>
        {%- endif %}
    {%- endfor %}
{%- endmacro -%}